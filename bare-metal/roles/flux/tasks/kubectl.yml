---
- name: Kubectl | Get Latest Version
  set_fact:
    kubectl_latest: "{{ lookup('url', 'https://dl.k8s.io/release/stable.txt') }}"

- name: Kubectl | Download Binary
  get_url:
    url: 'https://dl.k8s.io/release/{{kubectl_latest}}/bin/linux/amd64/kubectl'
    dest: /tmp

- name: Kubectl | Copy binary to /bin
  ansible.builtin.copy:
    src: /tmp/kubectl
    dest: /usr/local/bin
    owner: root
    group: root
    mode: u+x,g+x,o+rwx

# kubectl check if existing config exists on localhost
- name: Kubectl | Check if updated /tmp/kubeconfig file exists
  stat:
    path: /tmp/kubeconfig
  register: result

- name: Kubectl | Updating config file
  ansible.builtin.copy:
    src: /tmp/kubeconfig
    dest: '{{ kubectl_configpath }}/config'
    backup: yes
  when: (result.stat.isdir is undefined) or (not result.stat.isdir)

- name: Kubectl | Remove tmp file
  ansible.builtin.file:
    path: /tmp/kubeconfig
    state: absent
